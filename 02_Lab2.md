# Lab 2

## Introduction

In this exercise you will set up an example FHIR server, fill it with patient data and do some simple tasks with the server.

For this exercise, the FHIR server runs inside a Docker container. Docker is already installed and ready to use on your virtual machine.

## Download and start the container
Docker is set up on the virtual machine and should start upon login. However, it may take some time until it is ready.

**Note:** The Docker desktop does not need to be started.

Bring up a *Command Prompt Window (cmd)* and run the container:

```bash
docker run -dp 8080:8080 hapiproject/hapi:latest
```

In case that the container is not present on your machine, you can download the latest version of the FHIR server container with the command

```bash
docker pull hapiproject/hapi:latest
```

Now the FHIR Base should be available here:

`http://localhost:8080/fhir/patient`

The response should contain "total": 0 patients. The server is empty!

![The FHIR server is empty](/assets/FHIR_server_empty.png)

Further information about the HAPI FHIR implementation can be found here: https://github.com/hapifhir/hapi-fhir-jpaserver-starter

## Task 1 - Examining our server

First we want to find out what our server can do. We can find out by looking at the response of the metadata request. This is possible directly via the URL: `http://localhost:8080/fhir/metadata` or using a REST client to perform a GET request.

The CapabilityStatement is very long (how many lines?) It is list of all supported resources follows.

1. Look for the following meta information: What is the version of the server?

> The information can be found in the attribute `software.versiom`

2. Which status of the FHIR standard is implemented?

> The information can be found in the attribute: `fhirVersion`

A combination of resources that is very common and useful is the triplet `"Patient"/"Encounter"/"Diagnostic Report"`. This combination is used, for example, to model an `Encounter` in which a `Patient` undergoes an examination the result thereof gets documented in a `DiagnosticReport`.

3. Can you find the relevant resources in the capability statement?

![The FHIR Patient resource](/assets/FHIR_Patient.png)

![The FHIR Encounter resource](/assets/FHIR_Encounter.png)

![The FHIR DiagnosticReport resource](/assets/FHIR_DiagnosticReport.png)


In the description of each of these resources there are very interesting fields such as "searchInclude" and "searchParam". What are these?

> `searchParamm` lists all parameters which can be used in a search as filter criteria.
> `searchInclude`
> `searcRevInclude`

## Task 2 - Filling our server with patient data

In order to be able to work meaningfully with the server, we have to fill it with patient data. There are different possibilities for this. We use synthea to generate sample patients. https://github.com/synthetichealth/synthea

We use the “Basic Setup and Running instructions”: https://github.com/synthetichealth/synthea/wiki/Basic-Setup-and-Running
Download the program to your personal drive in a subdirectory "eHealth/Synthea".
https://github.com/synthetichealth/synthea/releases/download/master-branch-latest/synthea-with-dependencies.jar

Now generate 20 patients with the patient generator. See the page linked above instructions and examples of how to do this. Use the default settings.

```java
java -jar synthea-with-dependencies.jar -p 20
```

Note: the patients are generated according to the US profile. It is possible to use international profiles (https://github.com/synthetichealth/synthea-international). For our current purposes, however, the default settings are sufficient.

Now we have to upload the patients to the server. For this we use the following python script https://gist.github.com/rafamayo/1731e489b114a8cb1ac4c3f8fbc6e9fc

Download the script into the subdirectory "eHealth/FHIR-uploader".

Caution: In the script check that the "FHIR Server endpoint" and the path to the patient files matches your configuration!

Now you can run the script from the "eHealth/FHIR-uploader" directory.

```python
python upload-fhir-bundle.py
```
The python package 'requests' must be installed.

If everything was successful, you should now have patients on your local server. You could now repeat the taks from Lab 1 with your own server.

## Task 3 - Setting up a client

Using a REST client is a good thing for test purposes when developing an API. In the context of FHIR we can use a REST client to learn about the basic capabilities of the standard. However when you want to implement a productive solution you will want to work with FHIR from *within* a programming language.  

There are client implementations for different programming languages. Here we will use the python client from SMART. The client documentation is here: http://docs.smarthealthit.org/client-py/

The HAPI Server requires version 4.0.0 of the SMART fhir client, but pip (usually) installs version 3.2.0. The correct version must be installed manually. The repository can be found here: https://github.com/smart-on-fhir/client-py. The instructions to get the distribution running are here: https://github.com/smart-on-fhir/client-py#building-distribution

You need to do the following: clone the repository to your local machine, change into the root folder of the package and run the following commands to build the distribution

```python
pip install -r requirements.txt
python setup.py sdist
python setup.py bdist_wheel
```

Then you install the module by running this:

```python
python setup.py install
```

This way the correct version will be installed. You can check the installed version with

```python
pip list
```


## Task 4 - Using the python client

Now we use the python client to perform some tasks on our own FHIR server

### Part 1: Create an organization

We will start by creating an organization (a healthcare service provider). The FHIR resource is here: http://hl7.org/fhir/organization.html

```python
import json
from fhirclient import client

import fhirclient.models.patient as pat
import fhirclient.models.humanname as hn
import fhirclient.models.address as ad
import fhirclient.models.organization as org
import fhirclient.models.codeableconcept as codecon
import fhirclient.models.coding as cod
import fhirclient.models.practitioner as prac
import fhirclient.models.contactpoint as cp
import fhirclient.models.fhirreference as ref 

def pretty(js):
# pretty print a json object
    return json.dumps(js, indent=2)


settings = {
    'app_id': 'my_web_app',
    'api_base': 'http://localhost:8080/fhir' # you can change this to match your FHIR server endpoint
}

myClient = client.FHIRClient(settings=settings)

print('***\nPart 1: Create an Organizstion\n***')

# Create the empty organization
organization = org.Organization()
organization.active = True
organization.name = 'Fast&Sleek Lab' 

codeableconcept = codecon.CodeableConcept()
coding = cod.Coding()
coding.code = 'prov'
coding.display = 'Healthcare service provider - Laboratory'
coding.system = 'http://terminology.hl7.org/CodeSystem/organization-type'
codeableconcept.coding = [coding]
codeableconcept.text = 'Type of healthcare service provider'
organization.type = [codeableconcept]

address = ad.Address()
address.text = '1 Main Street, 99999 Hawkins, USA'
address.postalCode = '99999'
address.city = 'Hawkins'
address.country = 'USA'
organization.address = [address]

# show the organization so far
print("The organization so far (LOCAL):")
print(pretty(organization.as_json()))

# Now create the organization on the server
# This is whre the interaction with the server is going to take place 
result = organization.create(myClient.server)
# show the returned result
print("Result from the creation transaction (REMOTE): ")
print(pretty(result))
print("Returned orgaization id: " + str(result["id"]))
```

### Part 2: Create a practitioner locally and show it

```python
print('***\nPart 2: Create a new Practitioner\n***')

# create the empty practitioner
practitioner = prac.Practitioner()
practitioner.active = True
name = hn.HumanName()
name.given = ['James']
name.family = 'Smith'
name.prefix = ['Dr.']
name.use = 'official'
practitioner.name = [name]
address = ad.Address()
address.city = 'Hawkins'
address.country = 'USA'
address.text = '1 Main Street, 99999 Hawkins, USA'
address.postalCode = '99999'
practitioner.address = [address]
telecom = cp.ContactPoint()
telecom.system = 'phone'
telecom.value = '055512345589'
practitioner.telecom = [telecom]

# show the practitioner so far
print("The practitioner so far (LOCAL):")
print(pretty(practitioner.as_json()))

#
# Create the practitioner in the server
#
result = practitioner.create(myClient.server)
# show the returned result
print("Result from the creation transaction (REMOTE): ")
print(pretty(result))
print("Returned practitioner id: " + str(result["id"]))
```

### Part 3: Create a basic patient

```python
print('***\nPart 3: Create a new Patient\n***')

# create the empty patient
patient = pat.Patient()
# give the patient a name
name = hn.HumanName()
name.given = ['Will']
name.family = 'Byers'
name.use = 'official'
patient.name = [name]
address = ad.Address()
address.city = 'Hawkins'
address.country = 'USA'
address.text = 'Mirkwood, 99999 Hawkins, USA'
address.postalCode = '99999'
patient.address = [address]

# show the patient so far
print("The patient so far (LOCAL):")
print(pretty(patient.as_json()))

#
# Create the patient on the server
#
result = patient.create(myClient.server)
# show the returned result
print("Result from the creation transaction (REMOTE): ")
print(pretty(result))
print("Returned patient id: " + str(result["id"]))
```

## Task 5 - References is FHIR

A very important concept in FHIR are references. Using references we can link resources together to model a more complex situation. The references are also used to allow advanced searches.

### Part 4: Linking the patient to the practitioner

The patient we created in part 3 is being treated by the practitioner we created in part 2. To link them, we create a reference on the patient pointing to the practitioner resource. The documentation of the Patient resource (https://www.hl7.org/fhir/patient.html#resource) shows the possible references of this resource. One of them is a reference to the Practitioner:

![The FHIR DiagnosticReport resource](/assets/FHIR_reference_practitioner.png)

What other references are possible? Can you find them.

We will update our patient with a reference to the practioner. To do that we will need the Practioner's id (this was automatically assigned by the server). We suppose that we know the practitioner's name (maybe selected from a drop-down box in our web application) and will use the name as search parameter.

```python
# Search for the practitioner on the server. We know the practitioner's name "Smith"
search = prac.Practitioner.where(struct={'name':'Smith'})
practitioners = search.perform_resources(myClient.server)
for practitioner in practitioners:
    print(pretty(practitioner.as_json()))
    
# The patient has a reference to his general practitioner
# We create the reference and use the returned paractioner's id
generalpractitioner = ref.FHIRReference()
generalpractitioner.reference = 'Practitioner/' + practitioners[0].id
generalpractitioner.type = 'Practitioner'

# show the reference object
print("The reference object (LOCAL):")
print(pretty(generalpractitioner.as_json()))

# Now that we have the reference object created, we assign this reference object to the corresponding attribute of the patient
# First let's get the patient. Our patient is Will Byers, let's get him from the server. 
search = pat.Patient.where(struct={'given':'Will', 'family':'Byers'})
patients = search.perform_resources(myClient.server)
for patient in patients:
    print(pretty(patient.as_json()))

# We assume that we only have one Will Byers, our patient is in patients[0]
patient = patients[0]
# Let's check that everything is correct
print("Patient's id: " + patient.id)
print("Patient's name: " + smart.human_name(patient.name[0]))

# Now we update the patient with the reference to the practitioner
# Note from the documentation, that there could be more than one practitioner, hence the list
patient.generalPractitioner = [generalpractitioner]
# What does the patient look like right now?
print("The updated patient (LOCAL): ")
print(pretty(patient.as_json()))

# Perform the update on the server
result = patient.update(smart.server)
# Show the result of the request
print("The updated patient (REMOTE): ")
print("Result of the update:")
print(pretty(result))
```

You can check that it worked by performing a GET with the REST client or directly on the browser 

## Task 6 - Homework

I have shown you how to use references to link resources together. Now you do this yourself.

### Part 5: Adding an observation

Our patient gets some tests done in the lab. This is documented using an observation https://www.hl7.org/fhir/observation.html.
The test is a "C reactive protein [Mass/volume] in Serum or Plasma" (to test for serious infection). This test has the LOINC code 1988-5 (https://loinc.org/1988-5/.)

The Observation needs a reference to the patient ("Will Byers") and to the performer ("Dr. Sam Owens")

Proceed similarly to the example in Part 4: create an observation locally adding the references to the patient and practitioner and then sen the request to create the observation on the server. You might have to search for them first. **Pay attention to the requiered attributes!**

```python
import json
from fhirclient import client

import fhirclient.models.patient as pat
import fhirclient.models.humanname as hn
import fhirclient.models.address as ad
import fhirclient.models.organization as org
import fhirclient.models.codeableconcept as codecon
import fhirclient.models.coding as cod
import fhirclient.models.practitioner as prac
import fhirclient.models.contactpoint as cp
import fhirclient.models.fhirreference as ref 

import fhirclient.models.observation as obs

def pretty(js):
# pretty print a json object
    return json.dumps(js, indent=2)


settings = {
    'app_id': 'my_web_app',
    'api_base': 'http://localhost:8080/fhir' # you can change this to match your FHIR server endpoint
}

myClient = client.FHIRClient(settings=settings)


observation = obs.Observation()

observation.status = 'final'

codeableconcept = codecon.CodeableConcept()
codeableconcept.text = 'C reactive protein [Mass/volume] in Serum or Plasma'

coding = cod.Coding()
coding.code = '1988-5'
coding.display = 'C reactive protein [Mass/volume] in Serum or Plasma'
coding.system = 'https://loinc.org/fhir/loinc.xml'
codeableconcept.coding = [coding]

observation.code = codeableconcept

# show the observation object (Local)
print("The observation object (LOCAL):")
print(pretty(observation.as_json()))

# To create the references to the patient and to the paractioner, we need to get them first from the server
# The patient is Will Byers
search = pat.Patient.where(struct={'given':'Will', 'family':'Byers'})
patients = search.perform_resources(myClient.server)

# We assume that we only have one Will Byers, our patient is in patients[0]
patient = patients[0]
# Let's check that everything is correct
print("Patient's id: " + patient.id)
print("Patient's name: " + myClient.human_name(patient.name[0]))

# The practitioner is James Smith
search = prac.Practitioner.where(struct={'family':'Smith', 'given':'James'})
practitioners = search.perform_resources(myClient.server)

# We assume that we only have one practitioner James Smith, the practitioner is in practitioners[0]
practitioner = practitioners[0]
# Let's check that everything is correct
print("Practitioner's id: " + practitioner.id)
print("Practitioner's name: " + myClient.human_name(practitioner.name[0]))

# We create the reference to the patient and use the returned patient's id
patientRef = ref.FHIRReference()
patientRef.reference = 'Patient/' + patient.id
patientRef.type = 'Patient'

# We create the reference to the paractitioner and use the returned parctitioners's id
practitionerRef = ref.FHIRReference()
practitionerRef.reference = 'Practitioner/' + practitioner.id
practitionerRef.type = 'Practitioner'

# Finally assign the references to the correct attributes of the observation
observation.subject = patientRef
observation.performer = [practitionerRef]

# show the observation object (Local)
print("The observation object (LOCAL):")
print(pretty(observation.as_json()))

# Create the observation on the server
result = observation.create(myClient.server)
# show the returned result
print("Result from the creation transaction (REMOTE): ")
print(pretty(result))
```

You can check that it worked by performing a GET with the REST client or directly on the browser 

### Part 6: advanced searches

We have now created some references connecting several resources together. We can now do some more interesting searches. For example, suppose we have a practitioner and we want to find all patients that are being treated by that practitioner. Remember that it is the patients who have a reference to their practitioner and not the other way around (see part 4). So how do we do this? 

#
# TODO
#

# 1) Add observations
# For example: 
# code = '33914-3'
# display = 'Glomerular filtration rate/1.73 sq M.predicted by Creatinine-based formula (MDRD)'
# system = 'http://loinc.org'
# The observations must have a reference to a patient
# The observations must have a reference to a performer (here the lab -> an organization)

# 2) Perform searches with references
# Search for all patients of a specific practitioner
# Search for all observations for a specific patient

# 3) Add different observations to a patient
# Examples here -> https://www.hl7.org/fhir/observation.html
# The observations are performed by different labs/paractitioners
# You will need to add several organizations

# 4) Create observations for several patients

# 5) Create more complex searches:
# For example: for a specific patient, search for all observations that were performed by a specific performer
# How can you do this?
# Do you have other examples?
